#!/bin/bash

TARGET="$1"
RESULTS_DIR="./results"
NUCLEI_TEMPLATES="/path/to/your/nuclei-templates"
PRIV8_NUCLEI_CRLF="/path/to/your/priv8-nuclei/crlf/crlf.yaml"
SUBDOMAINS_ALIVE="$RESULTS_DIR/live_subdomains.txt"
SCRIPT_PATH="$0"

# Function to prompt for directory and update script
prompt_and_update() {
  VARIABLE_NAME="$1"
  PROMPT_TEXT="$2"
  CURRENT_VALUE="$3"

  if [ ! -d "$CURRENT_VALUE" ]; then
    echo "Warning: $PROMPT_TEXT not found at '$CURRENT_VALUE'."
    read -p "Please enter the correct path for $PROMPT_TEXT: " NEW_PATH
    if [ -d "$NEW_PATH" ]; then
      sed -i "s#$VARIABLE_NAME=\"$CURRENT_VALUE\"#$VARIABLE_NAME=\"$NEW_PATH\"#g" "$SCRIPT_PATH"
      echo "$VARIABLE_NAME updated to '$NEW_PATH' in the script."
      source "$SCRIPT_PATH" # Reload the script with the new variable
    else
      echo "Error: Invalid path provided for $PROMPT_TEXT. Using default."
    fi
  fi
}

echo "[+] Starting Vulnerability Scan for $TARGET"

# Auto-configure Nuclei Templates path
prompt_and_update "NUCLEI_TEMPLATES" "Nuclei Templates Directory" "$NUCLEI_TEMPLATES"

# Auto-configure Private Nuclei CRLF Template path
prompt_and_update "PRIV8_NUCLEI_CRLF" "Private Nuclei CRLF Template File" "$PRIV8_NUCLEI_CRLF"

if [ ! -f "$SUBDOMAINS_ALIVE" ]; then
  echo "Error: $SUBDOMAINS_ALIVE not found. Run live subdomain check first."
  exit 1
fi

echo "  [+] Scanning main domain with Nuclei (cves,osint,tech)..."
nuclei -t "$NUCLEI_TEMPLATES" -u "https://$TARGET" -tags cves,osint,tech -o "$RESULTS_DIR/nuclei_main_cves_osint_tech.txt"

echo "  [+] Scanning main domain with Nikto..."
nikto -h "https://$TARGET" -output "$RESULTS_DIR/nikto_main_report.txt"

echo "  [+] Scanning live subdomains with Nuclei (cves,osint,tech)..."
cat "$SUBDOMAINS_ALIVE" | while read -r subdomain; do
  echo "    [+] Scanning $subdomain with Nuclei (cves,osint,tech)..."
  nuclei -t "$NUCLEI_TEMPLATES" -u "https://$subdomain" -tags cves,osint,tech -o "$RESULTS_DIR/nuclei_$subdomain_cves_osint_tech.txt"
  echo "    [+] Scanning $subdomain with Nikto..."
  nikto -h "https://$subdomain" -output "$RESULTS_DIR/nikto_$subdomain_report.txt"
done

echo "  [+] Scanning live subdomains with Nuclei (CRLF)..."
if [ -f "$PRIV8_NUCLEI_CRLF" ]; then
  cat "$SUBDOMAINS_ALIVE" | nuclei -t "$PRIV8_NUCLEI_CRLF" -v -o "$RESULTS_DIR/nuclei_crlf_scan.txt"
else
  echo "Warning: CRLF Nuclei template not found at '$PRIV8_NUCLEI_CRLF'. Skipping CRLF scan."
fi

echo "[+] Vulnerability Scan Complete. Results are in $RESULTS_DIR/"*scan*.txt and $RESULTS_DIR/"*report*.txt"